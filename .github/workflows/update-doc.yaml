name: Generate Label Documentation

on:
  pull_request:

jobs:
  update-documentation:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1
      matrix:
        repo: [polkadot, cumulus]

    steps:
      - name: Checkout sources
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Install tooling
        run: |
          URL=https://github.com/chevdor/tera-cli/releases/download/v0.2.3/tera-cli_linux_amd64.deb
          wget $URL -O tera.deb
          sudo dpkg -i tera.deb
          tera --version

      - name: Generate the doc for ${{ matrix.repo }}
        run: |
          export DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          export COMMIT=$(git rev-parse HEAD)
          tera --env --env-key env --template templates/template.md.tera ruled_labels/specs_${{ matrix.repo }}.yaml > ./docs/doc_${{ matrix.repo }}.md
          ls -al ./docs

      - name: Commit the changes
        run: |
          git config --global user.name 'TeraBot'
          git config --global user.email 'chevdor@users.noreply.github.com'
          git config --global push.default current
          git add ./docs
          git pull
          git commit ./docs -m "Update label documentation" || true
          git push
